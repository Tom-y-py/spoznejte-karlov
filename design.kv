#:kivy 2.0
#:import hex kivy.utils.get_color_from_hex

# --- DEFINICE BAREV A STYLŮ ---
<Label>:
    font_name: 'Roboto'
    color: hex('#eeeeee')

<NavButton@Button>:
    background_normal: ''
    background_color: hex('#d4af37')
    color: hex('#000000')
    font_size: '18sp'
    bold: True
    size_hint: None, None
    size: 200, 60
    # ÚPRAVA PRO ZALAMOVÁNÍ TEXTU
    text_size: self.size
    halign: 'center'
    valign: 'middle'

# Obecný klikací panel
<ClickablePane@ButtonBehavior+RelativeLayout>:

# Klikací kontejner pro galerii
<ClickableImageContainer@ButtonBehavior+RelativeLayout>:

# --- Komponenta pro jeden blok galerie ---
<GalleryBlock>:
    orientation: 'vertical'
    size_hint_y: None
    height: 550
    spacing: 10
    padding: [0, 20, 0, 20]
    
    ClickableImageContainer:
        size_hint_y: 0.75
        on_release: if root.click_action: root.click_action()
        
        # --- OPRAVA RÁMEČKU ---
        # V RelativeLayout je 0,0 levý dolní roh widgetu, ne okna.
        canvas.after:
            Color:
                rgba: hex('#d4af37')
            Line:
                width: 2
                rectangle: 0, 0, self.width, self.height
        # ----------------------
        
        Image:
            source: root.img_source
            allow_stretch: True
            keep_ratio: True
            fit_mode: "contain"
            pos_hint: {'center_x': 0.5, 'center_y': 0.5}

        # Ikonka lupy
        Label:
            text: "[b]+[/b]"
            markup: True
            font_size: '30sp'
            size_hint: None, None
            size: 50, 50
            pos_hint: {'right': 0.98, 'bottom': 0.02}
            color: hex('#d4af37')
            canvas.before:
                Color:
                    rgba: 0, 0, 0, 0.5
                Ellipse:
                    pos: self.pos
                    size: self.size

    Label:
        text: root.text_content
        size_hint_y: 0.25
        text_size: self.width, None
        halign: 'center'
        valign: 'top'
        font_size: '18sp'
        color: hex('#dddddd')

# --- Styl pro dlaždice v menu B ---
<ImageTile@ButtonBehavior+BoxLayout>:
    orientation: 'vertical'
    img_source: ''
    title_text: ''
    canvas.before:
        Color:
            rgba: 0, 0, 0, 1
        Rectangle:
            pos: self.pos
            size: self.size
    RelativeLayout:
        # OPRAVA RÁMEČKU I ZDE
        canvas.after:
            Color:
                rgba: hex('#d4af37')
            Line:
                width: 2
                rectangle: 0, 0, self.width, self.height
        Image:
            source: root.img_source
            allow_stretch: True
            keep_ratio: False
            opacity: 0.7
        Label:
            text: root.title_text
            font_size: '22sp'
            bold: True
            text_size: self.width - 20, None
            halign: 'center'
            valign: 'center'
            pos_hint: {'center_x': 0.5, 'center_y': 0.5}

# --- 1. MENU ---
<MainMenu>:
    BoxLayout:
        orientation: 'horizontal'
        spacing: 2
        canvas.before:
            Color: 
                rgba: 0, 0, 0, 1
            Rectangle: 
                pos: self.pos
                size: self.size
        ClickablePane:
            size_hint_x: 0.5
            on_release: app.root.current = 'section_a'
            Image:
                source: 'assets/Karl_Freiherr_von_Skoda,_Erfinder_der_Motorbatterien_1916_J._Vilímek.png' 
                allow_stretch: True
                keep_ratio: False
                opacity: 0.6
            Label:
                text: "Kdo byl\nPlzeňský Baťa?"
                font_size: '40sp'
                bold: True
                halign: 'center'
                pos_hint: {'center_x': 0.5, 'center_y': 0.5}
        ClickablePane:
            size_hint_x: 0.5
            on_release: app.root.current = 'section_b'
            Image:
                source: 'assets/Soucasnost.jpg'
                allow_stretch: True
                keep_ratio: False
                opacity: 0.6
            Label:
                text: "Prozkoumej\nKarlov"
                font_size: '40sp'
                bold: True
                halign: 'center'
                pos_hint: {'center_x': 0.5, 'center_y': 0.5}

# --- 2. KAREL ŠKODA ---
<SectionA>:
    canvas.before:
        Color: 
            rgba: hex('#1a1a1a')
        Rectangle: 
            pos: self.pos
            size: self.size
    FloatLayout:
        Label:
            text: "Karel Škoda (1878-1929)"
            font_size: '32sp'
            bold: True
            color: hex('#d4af37')
            size_hint: 1, 0.1
            pos_hint: {'top': 1}
        BoxLayout:
            orientation: 'horizontal'
            padding: 30
            spacing: 30
            size_hint: 1, 0.75
            pos_hint: {'top': 0.9}
            ScrollView:
                size_hint: 0.55, 1
                bar_width: 10
                bar_color: hex('#d4af37')
                Label:
                    text: root.text_content
                    markup: True
                    text_size: self.width, None
                    size_hint_y: None
                    height: self.texture_size[1]
                    font_size: '20sp'
                    line_height: 1.5
                    valign: 'top'
            BoxLayout:
                orientation: 'vertical'
                size_hint: 0.45, 1
                spacing: 20
                BoxLayout:
                    size_hint_y: 0.5
                    orientation: 'vertical'
                    Image:
                        source: 'assets/A1.jpg'
                        allow_stretch: True
                        keep_ratio: True
                    Label:
                        text: "Emil Škoda se synem Karlem"
                        font_size: '14sp'
                        size_hint_y: 0.15
                        color: hex('#aaaaaa')
                GridLayout:
                    cols: 2
                    spacing: 10
                    size_hint_y: 0.5
                    Button:
                        text: "Konzumní družstvo"
                        background_color: hex('#333333')
                        on_release: root.show_detail("Konzumní družstvo", "assets/A2.jpg", "Budovy bývalého konzumního družstva...")
                    Button:
                        text: "Kulturní dům"
                        background_color: hex('#333333')
                        on_release: root.show_detail("Kulturní dům", "assets/A3.jpg", "Bývalý kulturní dům Nebe...")
                    Button:
                        text: "Čtvrť Karlov"
                        background_color: hex('#333333')
                        on_release: root.show_detail("Čtvrť Karlov", "assets/A4.jpg", "Jeden z obytných domů...")
                    Button:
                        text: "Ohradní zeď"
                        background_color: hex('#333333')
                        on_release: root.show_detail("Ohradní zeď", "assets/A5.jpg", "Ohradní zeď Škodových závodů...")
                    Button:
                        text: "Techmanie"
                        background_color: hex('#333333')
                        on_release: root.show_detail("Techmanie", "assets/A6.jpg", "Budova 55, dnešní Techmanie...")
                    Button:
                        text: "Planetárium"
                        background_color: hex('#333333')
                        on_release: root.show_detail("Planetárium", "assets/A7.jpg", "Interiér budovy 56, dnes planetárium...")
        NavButton:
            text: "< Na začátek"
            pos_hint: {'x': 0.05, 'y': 0.03}
            on_release: app.root.current = 'menu'
        NavButton:
            text: "Objev Karlov >"
            pos_hint: {'right': 0.95, 'y': 0.03}
            background_color: hex('#eeeeee')
            color: hex('#000000')
            on_release: app.root.current = 'section_b'

# --- 3. ROZCESTNÍK KARLOV ---
<SectionB>:
    canvas.before:
        Color: 
            rgba: hex('#1a1a1a')
        Rectangle: 
            pos: self.pos
            size: self.size
    FloatLayout:
        Label:
            text: "Čtvrť Karlov"
            font_size: '32sp'
            bold: True
            color: hex('#d4af37')
            size_hint: 0.55, 0.1
            pos_hint: {'x': 0.05, 'top': 1.0}
            halign: 'left'
            text_size: self.size
        Label:
            text: root.text_content
            text_size: self.width, None
            size_hint: 0.55, None
            height: self.texture_size[1]
            halign: 'left'
            valign: 'top'
            font_size: '20sp'
            pos_hint: {'x': 0.05, 'top': 0.88}
        
        # Slideshow
        RelativeLayout:
            size_hint: 0.35, 0.45
            pos_hint: {'right': 0.98, 'top': 0.98}
            # OPRAVA RÁMEČKU - 0,0
            canvas.after:
                Color: 
                    rgba: hex('#d4af37')
                Line: 
                    width: 3
                    rectangle: 0, 0, self.width, self.height
            Image:
                id: slideshow_image
                fit_mode: "cover"
                size_hint: 1, 1
                pos_hint: {'center_x': 0.5, 'center_y': 0.5}
        
        # Dlaždice
        BoxLayout:
            orientation: 'horizontal'
            spacing: 20
            size_hint: 0.9, 0.30
            pos_hint: {'center_x': 0.5, 'y': 0.15}
            ImageTile:
                title_text: "Jak se stavěl\nKarlov"
                img_source: 'assets/Ba.jpg'
                on_release: app.root.current = 'section_b1'
            ImageTile:
                title_text: "Život na\nKarlově"
                img_source: 'assets/Bb.jpg'
                on_release: app.root.current = 'section_b2'
            ImageTile:
                title_text: "Dvojí zánik\nKarlova"
                img_source: 'assets/Bc.jpg'
                on_release: app.root.current = 'section_b3'
        
        # Navigace
        BoxLayout:
            orientation: 'horizontal'
            spacing: 15
            size_hint: None, None
            size: 420, 60
            pos_hint: {'right': 0.95, 'y': 0.03}
            NavButton:
                text: "Karel Škoda"
                on_release: app.root.current = 'section_a'
            NavButton:
                text: "Na začátek"
                background_color: hex('#eeeeee')
                on_release: app.root.current = 'menu'

# --- 4. B1: JAK SE STAVĚL KARLOV ---
<SectionB1>:
    canvas.before:
        Color:
            rgba: hex('#1a1a1a')
        Rectangle:
            pos: self.pos
            size: self.size

    FloatLayout:
        Label:
            text: "Jak se stavěl Karlov"
            font_size: '32sp'
            bold: True
            color: hex('#d4af37')
            size_hint: 1, 0.1
            pos_hint: {'top': 1}
        
        ScrollView:
            size_hint: 0.9, 0.82
            pos_hint: {'center_x': 0.5, 'top': 0.92}
            bar_width: 10
            bar_color: hex('#d4af37')
            
            BoxLayout:
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height 
                spacing: 30
                padding: [20, 20, 20, 50]

                Label:
                    text: root.intro_text
                    text_size: self.width, None
                    size_hint_y: None
                    height: self.texture_size[1] + 40
                    halign: 'center'
                    font_size: '22sp'
                    color: hex('#ffffff')

                # B1a
                GalleryBlock:
                    img_source: 'assets/B1a.jpg'
                    text_content: root.desc_b1a
                    click_action: lambda: root.show_timed_popup("Plány čtvrtě", "assets/B1a.jpg")

                # B1b
                GalleryBlock:
                    img_source: 'assets/B1b.jpg'
                    text_content: root.desc_b1b
                    click_action: lambda: root.show_timed_popup("Výstavba domů", "assets/B1b.jpg")

                # B1c
                GalleryBlock:
                    img_source: 'assets/B1c.jpg'
                    text_content: root.desc_b1c
                    click_action: lambda: root.show_timed_popup("Proměna Karlova", "assets/B1c.jpg", "assets/Soucasnost.jpg")

                Widget:
                    size_hint_y: None
                    height: 50

        # Navigace dole
        BoxLayout:
            orientation: 'horizontal'
            size_hint: 1, 0.1
            pos_hint: {'y': 0}
            padding: [20, 10, 20, 10]
            canvas.before:
                Color:
                    rgba: hex('#1a1a1a')
                Rectangle:
                    pos: self.pos
                    size: self.size
                Color:
                    rgba: hex('#333333')
                Line:
                    points: [self.x, self.height, self.width, self.height]
                    width: 1

            NavButton:
                text: "< Na začátek"
                on_release: app.root.current = 'menu'
            
            Widget: 
                size_hint_x: 1 
            
            NavButton:
                text: "Zpět na rozcestník"
                background_color: hex('#eeeeee')
                on_release: app.root.current = 'section_b'

# --- 5. B2: ŽIVOT NA KARLOVĚ ---
<SectionB2>:
    canvas.before:
        Color:
            rgba: hex('#1a1a1a')
        Rectangle:
            pos: self.pos
            size: self.size

    FloatLayout:
        Label:
            text: "Život na Karlově"
            font_size: '32sp'
            bold: True
            color: hex('#d4af37')
            size_hint: 1, 0.1
            pos_hint: {'top': 1}
        
        ScrollView:
            size_hint: 0.9, 0.82
            pos_hint: {'center_x': 0.5, 'top': 0.92}
            bar_width: 10
            bar_color: hex('#d4af37')
            
            BoxLayout:
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height 
                spacing: 30
                padding: [20, 20, 20, 50]

                Label:
                    text: root.intro_text
                    text_size: self.width, None
                    size_hint_y: None
                    height: self.texture_size[1] + 40
                    halign: 'center'
                    font_size: '22sp'
                    color: hex('#ffffff')

                # B2a
                GalleryBlock:
                    img_source: 'assets/B2a.jpg'
                    text_content: root.desc_b2a
                    click_action: lambda: root.show_timed_popup("Škola na Karlově", "assets/B2a.jpg", "assets/B2a_in.jpg")

                # B2b
                GalleryBlock:
                    img_source: 'assets/B2b1.jpg'
                    text_content: root.desc_b2b
                    click_action: lambda: root.show_timed_popup("Lidový dům", "assets/B2b1.jpg", "assets/B2b2.jpg")

                # B2c
                GalleryBlock:
                    img_source: 'assets/B2c2.jpg'
                    text_content: root.desc_b2c
                    click_action: lambda: root.show_timed_popup("Sport a fotbal", "assets/B2c2.jpg", "assets/B2c1.png")

                Widget:
                    size_hint_y: None
                    height: 50

        # Navigace dole
        BoxLayout:
            orientation: 'horizontal'
            size_hint: 1, 0.1
            pos_hint: {'y': 0}
            padding: [20, 10, 20, 10]
            canvas.before:
                Color:
                    rgba: hex('#1a1a1a')
                Rectangle:
                    pos: self.pos
                    size: self.size
                Color:
                    rgba: hex('#333333')
                Line:
                    points: [self.x, self.height, self.width, self.height]
                    width: 1

            NavButton:
                text: "< Na začátek"
                on_release: app.root.current = 'menu'
            
            Widget: 
                size_hint_x: 1 
            
            NavButton:
                text: "Zpět na rozcestník"
                background_color: hex('#eeeeee')
                on_release: app.root.current = 'section_b'

# --- 6. B3: DVOJÍ ZÁNIK KARLOVA ---
<SectionB3>:
    canvas.before:
        Color:
            rgba: hex('#1a1a1a')
        Rectangle:
            pos: self.pos
            size: self.size

    FloatLayout:
        Label:
            text: "Dvojí zánik Karlova"
            font_size: '32sp'
            bold: True
            color: hex('#d4af37')
            size_hint: 1, 0.1
            pos_hint: {'top': 1}
        
        ScrollView:
            size_hint: 0.9, 0.82
            pos_hint: {'center_x': 0.5, 'top': 0.92}
            bar_width: 10
            bar_color: hex('#d4af37')
            
            BoxLayout:
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height 
                spacing: 30
                padding: [20, 20, 20, 50]

                Label:
                    text: root.intro_text
                    text_size: self.width, None
                    size_hint_y: None
                    height: self.texture_size[1] + 40
                    halign: 'center'
                    font_size: '22sp'
                    color: hex('#ffffff')

                # B3a
                GalleryBlock:
                    img_source: 'assets/B3a.jpg'
                    text_content: root.desc_b3a
                    click_action: lambda: root.show_timed_popup("Nálety (1945)", "assets/B3a.jpg", "assets/B3b.jpg")

                # B3b
                GalleryBlock:
                    img_source: 'assets/B3c.jpg'
                    text_content: root.desc_b3b
                    # Zde použity B3c a B3d, upravte dle reálných názvů
                    click_action: lambda: root.show_timed_popup("Demolice (80. léta)", "assets/B3c.jpg", "assets/B3d.jpg")

                Widget:
                    size_hint_y: None
                    height: 50

        # Navigace dole
        BoxLayout:
            orientation: 'horizontal'
            size_hint: 1, 0.1
            pos_hint: {'y': 0}
            padding: [20, 10, 20, 10]
            canvas.before:
                Color:
                    rgba: hex('#1a1a1a')
                Rectangle:
                    pos: self.pos
                    size: self.size
                Color:
                    rgba: hex('#333333')
                Line:
                    points: [self.x, self.height, self.width, self.height]
                    width: 1

            Widget: 
                size_hint_x: 1 
            
            NavButton:
                text: "Na začátek"
                background_color: hex('#eeeeee')
                on_release: app.root.current = 'menu'

# --- Detail Popup (Pro A) ---
<DetailPopup>:
    size_hint: 0.85, 0.85
    auto_dismiss: True
    background_color: 0, 0, 0, 0.8
    BoxLayout:
        orientation: 'vertical'
        padding: 2
        canvas.before:
            Color: 
                rgba: hex('#d4af37')
            Line: 
                width: 2
                rectangle: self.x, self.y, self.width, self.height
            Color: 
                rgba: hex('#1a1a1a')
            Rectangle: 
                pos: self.pos
                size: self.size
        AnchorLayout:
            anchor_x: 'right'
            anchor_y: 'top'
            size_hint_y: 0.1
            padding: 10
            Button: 
                text: "X"
                size_hint: None, None
                size: 50, 50
                background_normal: ''
                background_color: hex('#cc0000')
                bold: True
                on_release: root.dismiss()
        Image: 
            source: root.img_source
            allow_stretch: True
            keep_ratio: True
            size_hint_y: 0.7
        Label: 
            text: root.desc_text
            font_size: '22sp'
            size_hint_y: 0.2
            text_size: self.width - 40, None
            halign: 'center'
            valign: 'middle'

# --- NOVÝ POPUP S ČASOVAČEM (Pro B1, B2, B3) ---
<TimedDetailPopup>:
    size_hint: 0.85, 0.85
    auto_dismiss: True
    background_color: 0, 0, 0, 0.0 # Pozadí řešíme přes canvas pro stín
    
    BoxLayout:
        orientation: 'vertical'
        padding: 2
        
        # Stín a pozadí
        canvas.before:
            # Stín
            Color:
                rgba: 0, 0, 0, 0.5
            Rectangle:
                pos: self.x - 5, self.y - 5
                size: self.width + 10, self.height + 10
            # Vlastní pozadí okna
            Color:
                rgba: hex('#1a1a1a')
            Rectangle:
                pos: self.pos
                size: self.size
            # Zlatý rám
            Color:
                rgba: hex('#d4af37')
            Line:
                width: 2
                rectangle: self.x, self.y, self.width, self.height

        # Horní lišta
        BoxLayout:
            size_hint_y: 0.1
            padding: 10
            spacing: 10
            
            Label:
                text: "Zavření za: " + str(root.time_remaining) + "s"
                color: hex('#aaaaaa')
                halign: 'left'
                size_hint_x: 0.8
                text_size: self.size

            Button:
                text: "X"
                size_hint: None, None
                size: 50, 50
                background_normal: ''
                background_color: hex('#cc0000')
                bold: True
                on_release: root.dismiss()

        # Kontejner pro fotku
        RelativeLayout:
            size_hint_y: 0.9 # ZVĚTŠENO PROSTOR PRO FOTKU
            
            Image:
                source: root.img_source
                allow_stretch: True
                keep_ratio: True
                pos_hint: {'center_x': 0.5, 'center_y': 0.5}

            Button:
                text: "PŘEPNOUT POHLED" if root.img_source_2 else ""
                opacity: 1 if root.img_source_2 else 0
                disabled: False if root.img_source_2 else True
                size_hint: None, None
                size: 200, 50
                pos_hint: {'center_x': 0.5, 'y': 0.05}
                background_color: hex('#d4af37')
                color: hex('#000000')
                bold: True
                on_release: root.toggle_image()